<!DOCTYPE html>
<html lang="zh-Hunt" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        h2 {
            text-align: center;
        }

        #calendar {
            max-width: 1100px;
            margin: 40px auto;
        }

        form {
            text-align: center;
        }

        input {
            margin: 5px;
        }
    </style>
    <title>預約評估</title>
</head>
<body>
<div th:insert="~{webpage/homepage.html:: headerFragment}"></div>
<main>
    <h2>進行預約</h2>
    <div id='calendar'></div>
    <h2>填寫表單</h2>
    <form id="reservation-form">
        <p>選擇時段</p>
        <div th:each="option:${options}" th:if="${options != null}">
            <input name="evaluationId" required th:value="${option.id}" type="radio">
            <label th:text="${option.detail}"></label>
        </div>
        <label>小朋友姓名: </label>
        <input name="clientName" required type="text">
        <br>
        <label>生日: </label>
        <input name="birthday" required type="date">
        <br>
        <label>聯絡電話: </label>
        <input name="tel" required type="text">
        <br>
        <label>信箱: </label>
        <input name="email" required type="text">
        <br>
        <button id="btn-reserve">送出</button>
    </form>
</main>
<div th:insert="~{webpage/homepage.html:: footerFragment}"></div>
</body>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script th:inline="javascript">
    $(document).ready(function () {
        let calendarEl = document.getElementById('calendar');
        let events = [[${events != null ? events : '[]'}]];

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: '2024-04-20',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: events
        });

        calendar.render();
    });
</script>
<script>
    const RELATIVE_PATH = window.location.origin;
    let currentUrl = new URL(window.location.href);

    // get domain name
    let domain = currentUrl.pathname.split('/')[1];

    $("#btn-reserve").click(function (event) {
        let form = $("#reservation-form")[0];
        if (!form.checkValidity()) {
            return;
        }
        event.preventDefault();
        let formData = new FormData(form);
        let endpoint = `${RELATIVE_PATH}/admin/${domain}/setting/evaluation/reserve`;
        try {
            (async function postData() {
                let response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                })
                if (response.ok) {
                    alert("成功預約評估")
                    setTimeout(function () {
                        window.location.href = `${RELATIVE_PATH}/${domain}/evaluation.html`;
                    }, 0);
                }
            })()
        } catch (error) {
            console.error('Error:', error);
        }
    })
</script>
</html>